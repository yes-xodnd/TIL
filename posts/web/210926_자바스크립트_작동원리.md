# 자바스크립트 작동 원리

자바스크립트로 작성한 코드가 어떻게 해석되고 실행되는지에 대해 학습하였습니다.

## 1. 자바스크립트 엔진

자바스크립트는 일반적으로 인터프리터 언어라고 하는데, 이는 런타임 전에 기계가 이해하기 쉬운 언어로 바꾸는 컴파일 단계를 거치지 않고 번역과 동시에 실행됨을 의미합니다. 

자바스크립트로 작성된 코드를 해석하고 실행하는 프로그램을 자바스크립트 엔진이라고 합니다. 브라우저 벤더마다 다른 자바스크립트 엔진을 사용하지만, 최근에는 구글의 V8 엔진을 탑재한 chromium 오픈소스 브라우저 기반 브라우저가 많은 점유율을 보이고 있습니다.

자바스크립트 엔진은 자바스크립트의 런타임 환경이라고도 합니다. 런타임 환경은 프로그램이 실행되는 환경으로 프로그램이 변수에 접근하는 방식, 운영체제와의 통신, 스택과 힙 관리, 가비지 컬렉션 등의 문제를 해결해줍니다.

## 2. 소스코드 해석과 실행

각 자바스크립트 엔진마다 다른 방식을 사용하겠지만, 가장 많이 사용되는 V8를 통해 엔진이 코드를 해석하고 실행하는 방식을 살펴보았습니다.

V8은 크게 파서, 인터프리터, 컴파일러로 나눌 수 있습니다. 먼저 파서를 통해 소스코드의 구조를 나타내는 AST(Abstract Syntax Tree, 추상구문트리)를 생성합니다. 인터프리터(Ignition)는 AST를 바탕으로 바이트코드를 생성하고 해당 코드를 실행시킵니다. 그리고 자주 실행되는 코드는 컴파일러(TurboFan)를 통해 기계어를 생성하여 성능을 최적화합니다.

## 3. 메모리 공간

자바스크립트 엔진 프로세스는 자바스크립트 코드 실행을 위해 할당받은 힙과 스택 메모리 영역을 사용합니다. 

### 3.1. 스택 

스택은 함수 호출과 함께 할당되며, 함수의 지역 변수, 매개변수 등의 데이터를 저장하는 영역입니다. 이름대로 스택과 같은 방식(LIFO)으로 동작합니다. 보통 콜 스택이라고 표현되며, 현재 실행되는 함수의 실행 컨텍스트를 저장하고 있으므로 실행 컨텍스트(Exection Context, EC) 스택이라고도 합니다. 자바스크립트 엔진은 하나의 스택을 통해 하나의 메인 스레드에서 작업을 수행하므로, 싱글 스레드라고 표현됩니다.

### 3.2. 힙

힙은 사용자가 직접 동적으로 할당하고 관리할 수 있는 메모리 영역입니다. 일반적으로 스택보다 큰 공간을 차지합니다. 자료구조 힙과 이름은 같지만, 상관은 없습니다.  

## 4. 비동기 작업

자바스크립트 코드가 모두 엔진을 통해서 실행될 수 있는 것은 아닙니다. 자바스크립트는 언어 명세(ECMAScript)에 포함되어 있지 않은, 브라우저에 의해 구현되고 실행되는 Web API(client-side Web API)에 접근하고 실행할 수 있습니다. Web API 기능들은 DOM API와 같이 동기적인 경우도 있고, Timeout처럼 비동기적인 경우도 있습니다. 비동기적인 작업의 스케줄링을 위해 자바스크립트 엔진은 이벤트 루프(event loop)와 태스크 큐(task queue)를 사용합니다. 

### 4.1. 태스크 큐

Web API의 비동기적인 작업이 끝나면, 완료된 작업의 콜백 함수가 태스크 큐에 보내집니다. 콜백 큐라고 표현하기도 합니다. 큐의 아이템들은 스택으로 보내져 실행됩니다. 

### 4.2. 이벤트 루프

이벤트 루프는 콜 스택과 태스크 큐를 지속적으로 확인하며, 스택이 비어있으면 태스크 큐의 아이템을 스택으로 보냅니다. 

### 4.3. 마이크로태스크 큐

일반 태스크(매크로태스크)보다 우선순위가 높은 작업을 관리하기 위한 태스크 큐로, 주로 프로미스 처리를 위해 생성되고 사용됩니다.

자바스크립트 엔진은 현재 처리중인 태스크를 처리하고 난 뒤, 렌더링 작업이나 다른 태스크 작업을 수행하기 전에 마이크로태스크 큐에 있는 모든 마이크로태스크를 처리합니다. 

표준 API인 `queueMicrotask` 를 이용해 특정 함수를 마이크로태스크로 처리하도록 할 수 있습니다.



## 5. 정리

항상 확실히 정리되지 않았던 자바스크립트로 작성된 코드가 해석되고 실행되는 과정, 그리고 싱글 스레드인 자바스크립트 엔진이 어떻게 작업들을 스케줄링하며 동시성을 구현하는지에 대해 간단하게나마 이해할 수 있었습니다. 특히 비동기 처리를 의도한 대로 구현하기 위해서는 이벤트 루프와 태스크 큐·마이크로태스크 큐의 동작에 대해 이해하는 것이 중요할 것 같습니다.

## 6. 참고 자료

>- [모던 JavaScript 튜토리얼 - 이벤트 루프와 매크로·마이크로태스크](https://ko.javascript.info/event-loop)
>- [Toast UI - 자바스크립트와 이벤트 루프](https://meetup.toast.com/posts/89)

